## 4.8

### 3.19 服务端没有 listen，客户端发起连接建立，会发生什么？

当然可以。你的问题涉及到计算机网络编程中客户端和服务端通信的基础知识，特别是基于 TCP/IP 协议的连接建立过程。为了更好地理解“服务端没有 `listen`，客户端发起连接建立会发生什么”这个问题，我们先简单介绍一下相关的背景。

#### 1、TCP 连接建立的基础
TCP（传输控制协议）是一种面向连接的可靠协议，在数据传输之前，客户端和服务端需要通过“三次握手”建立连接。这个过程通常涉及以下步骤：
1. **服务端准备**：
   - 服务端创建一个套接字（socket）。
   - 通过 `bind` 函数将套接字绑定到一个特定的 IP 地址和端口。
   - 调用 `listen` 函数，使该套接字进入监听状态，准备接受来自客户端的连接请求。
   - 调用 `accept` 函数，等待客户端连接并创建新的连接套接字。

2. **客户端发起连接**：
   - 客户端创建一个套接字。
   - 通过 `connect` 函数向服务端的 IP 地址和端口发起连接请求。
   - 如果服务端已监听该端口，三次握手成功后，连接建立。

#### 2、没有 listen，能建立 TCP 连接吗？

答案，**是可以的，客户端是可以自己连自己的形成连接（TCP自连接），也可以两个客户端同时向对方发出请求建立连接（TCP同时打开），这两个情况都有个共同点，就是没有服务端参与，也就是没有listen，就能建立连接**。

---

##### （1）TCP 自连接（Self-Connection）
**什么是 TCP 自连接？**

TCP 自连接是指一个客户端进程通过 TCP 协议连接到自己的同一台机器上的某个端口，形成一个“自环”连接。这种情况通常发生在客户端的 `connect` 请求的目标地址和端口恰好是本机的某个已绑定但未监听的端口。

**为什么不需要 `listen`？**

- 通常，TCP 连接需要服务端调用 `listen` 来进入监听状态，并通过 `accept` 接受客户端的连接请求。
- 但在自连接中，客户端直接通过 `connect` 发起连接，而操作系统可能会允许这种连接在特定条件下完成。
- **关键点**：如果客户端的套接字绑定了一个端口（通过 `bind`），然后尝试连接到自己（例如 `127.0.0.1` 上的同一端口），操作系统可能绕过传统的服务端监听逻辑，直接完成连接。

**举个例子**

假设一个程序：
1. 创建一个套接字 `sock`。
2. 用 `bind` 将其绑定到 `127.0.0.1:12345`。
3. 用 `connect` 连接到 `127.0.0.1:12345`。
- 在这种情况下，操作系统检测到目标地址是本机，且端口已被绑定，可能会直接建立连接，而无需显式的 `listen` 和 `accept`。
- 这本质上是一个“单进程内的连接”，数据通过本地协议栈循环传输。

**理解要点**

- **没有服务端角色**：自连接中，同一个进程既是“客户端”又是“服务端”，因此不需要独立的监听进程。
- **依赖实现**：是否成功取决于操作系统和 TCP 协议栈的具体实现，有些系统可能不允许这种行为。

---

##### 2. TCP 同时打开（Simultaneous Open）
**（1）什么是 TCP 同时打开？**

TCP 同时打开是指两个对等进程（没有明确的服务端/客户端角色区分）同时向对方发起连接请求，最终建立一条 TCP 连接。这种情况在三次握手中表现为双方同时发送 `SYN` 数据包。

**（2）过程是怎么样的？**

正常的 TCP 三次握手是：
1. 客户端发送 `SYN`。
2. 服务端回复 `SYN+ACK`。
3. 客户端发送 `ACK`。

而在同时打开中：
1. 进程 A（IP_A:Port_A）向进程 B（IP_B:Port_B）发送 `SYN`。
2. 与此同时，进程 B（IP_B:Port_B）向进程 A（IP_A:Port_A）发送 `SYN`。
3. 双方收到对方的 `SYN` 后，各自回复 `SYN+ACK`。
4. 最终双方都发送 `ACK`，连接建立。

**（3）为什么不需要 `listen`？**

- **对等角色**：在这个场景中，没有一方是传统意义上的服务端（即调用 `listen` 等待连接），双方都是主动发起连接的“客户端”。
- **协议支持**：TCP 协议本身支持这种对称的连接建立方式，称为“同时打开”。它是为了适应某些特殊应用场景（比如 P2P 网络）而设计的。
- **前提条件**：两个进程必须知道对方的 IP 和端口，并且在几乎同一时间发起连接。

**举个例子**

- 进程 A 在 `192.168.1.1:5000` 上绑定，并尝试连接 `192.168.1.2:6000`。
- 进程 B 在 `192.168.1.2:6000` 上绑定，并尝试连接 `192.168.1.1:5000`。
- 如果时机恰好，两个 `SYN` 交叉发送，TCP 协议栈会协商完成连接。

---

#### 3、共同点：没有服务端参与
这两种情况的核心在于：
- **没有传统服务端**：传统的 TCP 连接需要一方被动监听（`listen`），而自连接和同时打开中，连接的建立完全由主动发起方驱动。
- **主动发起**：双方（或单方对自己）通过 `connect` 触发连接，而不依赖 `listen` 和 `accept` 的被动接受机制。

**怎么理解？**

1. **TCP 的灵活性**：
   - TCP 协议设计时考虑了多种应用场景，不仅仅局限于“客户端-服务端”模型。自连接和同时打开是协议的边缘特性，虽然不常用，但在特定场景下（如调试、测试或 P2P 系统）有实际意义。

2. **操作系统角色**：
   - 在没有 `listen` 的情况下，连接能否建立取决于操作系统如何处理这些特殊请求。例如，自连接中，协议栈可能直接在本地完成“短路”连接。

3. **三次握手的本质**：
   - 三次握手的核心是双方协商并确认连接状态。只要双方的 `SYN` 和 `ACK` 能正确交换，连接就能建立，而这不一定需要一方处于监听状态。

